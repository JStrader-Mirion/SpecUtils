/* SpecUtils: a library to parse, save, and manipulate gamma spectrum data files.
 
 Copyright 2018 National Technology & Engineering Solutions of Sandia, LLC
 (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S.
 Government retains certain rights in this software.
 For questions contact William Johnson via email at wcjohns@sandia.gov, or
 alternative emails of interspec@sandia.gov.
 
 This library is free software; you can redistribute it and/or
 modify it under the terms of the GNU Lesser General Public
 License as published by the Free Software Foundation; either
 version 2.1 of the License, or (at your option) any later version.
 
 This library is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 Lesser General Public License for more details.
 
 You should have received a copy of the GNU Lesser General Public
 License along with this library; if not, write to the Free Software
 Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 */


#include <vector>
#include <iostream>

#include "SpecUtils/SpecFile.h"
#include "SpecUtils/EnergyCalibration.h"


void test_rebin_case( const std::vector<float> &original_energies,
                     const std::vector<float> &original_counts,
                     const std::vector<float> &new_energies )
{
  std::vector<float> resulting_counts;
  SpecUtils::rebin_by_lower_edge( original_energies, original_counts, new_energies, resulting_counts );
  
  double origsum = 0.0, newsum = 0.0;
  for( size_t i = 0; i < original_counts.size(); ++i )
    origsum += original_counts[i];
  for( size_t i = 0; i < resulting_counts.size(); ++i )
    newsum += resulting_counts[i];
  
  if( fabs(newsum-origsum) > 0.01*original_energies.size()/16384.0 )
    printf( "Failed with difference %f\n", (newsum-origsum) );
  printf( "Original %9f vs new %9f\n\n\n", origsum, newsum );
}//test_rebin_case

void test_rebin()
{
  {
    printf( "Trying case with coutns at very begging\n" );
    std::vector<float> original_energies{0.233857304, 0.421279311, 0.608701348, 0.796123266, 0.983545244, 1.17096734, 1.35838914, 1.54581118, 1.73323321, 1.92065525, 2.10807729, 2.29549932, 2.48292112, 2.67034316, 2.85776496, 3.045187, 3.23260903, 3.42003083, 3.60745287, 3.79487491, 3.98229694, 4.16971827, 4.35714054, 4.54456234, 4.73198366, 4.91940594, 5.10682774, 5.29425001, 5.48167181, 5.66909361, 5.85651541, 6.04393768, 6.23135948, 6.4187808, 6.60620308, 6.79362488, 6.98104668, 7.16846848, 7.35589075, 7.54331207, 7.73073435, 7.91815615, 8.10557747, 8.29299927, 8.48042202, 8.66784382, 8.85526466, 9.04268646, 9.23010826, 9.41753101, 9.60495281, 9.79237366, 9.97979546, 10.1672182, 10.35464, 10.5420609, 10.7294827, 10.9169044, 11.1043272, 11.291748, 11.4791698, 11.6665916, 11.8540144, 12.0414352, 12.228857, 12.4162788, 12.6037006, 12.7911224, 12.9785442, 13.165966, 13.3533869, 13.5408096, 13.7282314, 13.9156523, 14.1030741, 14.2904959, 14.4779177, 14.6653395, 14.8527613, 15.0401821, 15.2276049, 15.4150267, 15.6024475, 15.7898693, 15.9772911, 16.1647129, 16.3521347, 16.5395584, 16.7269802, 16.9144001, 17.1018219, 17.2892437, 17.4766655, 17.6640873, 17.8515072, 18.038929, 18.2263508, 18.4137745, 18.6011963, 18.7886162, 3051.85034, 3052.0376, 3052.2251, 3052.4126, 3052.59961, 3052.78711, 3052.97461, 3053.16187, 3053.34912, 3053.53662, 3053.72388, 3053.91113, 3054.09863, 3054.28589, 3054.47339, 3054.66064, 3054.84814, 3055.0354, 3055.22266, 3055.41016, 3055.59741, 3055.78491, 3055.97217, 3056.15942, 3056.34692, 3056.53442, 3056.72144, 3056.90894, 3057.09644, 3057.28345, 3057.47095, 3057.65845, 3057.8457, 3058.03296, 3058.22046, 3058.40771, 3058.59497, 3058.78247, 3058.96973, 3059.15723, 3059.34448, 3059.53198, 3059.71924, 3059.90674, 3060.09399, 3060.28125, 3060.46875, 3060.65601, 3060.84326, 3061.03076, 3061.21826, 3061.40527, 3061.59277, 3061.78027, 3061.96729, 3062.15479, 3062.34229, 3062.52954, 3062.7168, 3062.9043, 3063.09155, 3063.27905, 3063.46631, 3063.65381, 3063.84106, 3064.02832, 3064.21582, 3064.40308, 3064.59058, 3064.77783, 3064.96509, 3065.15259, 3065.33984, 3065.5271, 3065.7146, 3065.9021, 3066.08911, 3066.27661, 3066.46411, 3066.65137, 3066.83862, 3067.02612, 3067.21338, 3067.40063, 3067.58813, 3067.77539, 3067.96289, 3068.15015, 3068.33765, 3068.5249, 3068.71216, 3068.89966, 3069.08691, 3069.27441, 3069.46167, 3069.64893, 3069.83643, 3070.02393, 3070.21094};
    std::vector<float> original_counts{10, 9, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 2, 8, 36, 117, 216, 283, 318, 272, 305, 332, 295, 289, 295, 326, 294, 323, 315, 305, 278, 295, 271, 261, 283, 277, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 2, 0};
    std::vector<float> new_energies{-0.0297551602, 0.15851362, 0.346782386, 0.535051167, 0.723319948, 0.911588728, 1.09985757, 1.28812635, 1.47639513, 1.66466391, 1.85293269, 2.04120159, 2.22947025, 2.41773891, 2.60600781, 2.79427671, 2.98254538, 3.17081404, 3.35908294, 3.54735184, 3.7356205, 3.92388916, 4.1121583, 4.30042696, 4.48869562, 4.67696428, 4.86523294, 5.05350208, 5.24177074, 5.43003941, 5.61830854, 5.80657721, 5.99484587, 6.18311453, 6.37138319, 6.55965233, 6.74792099, 6.93618965, 7.12445879, 7.31272745, 7.50099611, 7.68926477, 7.87753344, 8.06580162, 8.25407124, 8.4423399, 8.63060856, 8.81887722, 9.00714588, 9.19541454, 9.3836832, 9.57195187, 9.76022053, 9.94849014, 10.1367588, 10.3250275, 10.5132961, 10.7015648, 10.8898335, 11.0781021, 11.2663717, 11.4546404, 11.642909, 11.8311777, 12.0194464, 12.207715, 12.3959837, 12.5842524, 12.772521, 12.9607906, 13.1490593, 13.337328, 13.5255966, 13.7138653, 13.9021339, 14.0904026, 14.2786722, 14.4669409, 14.6552095, 14.8434782, 15.0317469, 15.2200155, 15.4082842, 15.5965528, 15.7848215, 15.9730902, 16.1613598, 16.3496284, 16.537899, 16.7261677, 16.9144363, 17.102705, 17.2909737, 17.4792423, 17.667511, 17.8557796, 18.0440483, 18.232317, 18.4205856, 18.6088543, 3065.92725, 3066.11548, 3066.30396, 3066.49219, 3066.68042, 3066.86865, 3067.05688, 3067.24512, 3067.43335, 3067.62183, 3067.81006, 3067.99829, 3068.18652, 3068.37476, 3068.56299, 3068.75122, 3068.9397, 3069.12793, 3069.31616, 3069.50439, 3069.69263, 3069.88086, 3070.06934, 3070.25757, 3070.4458, 3070.63403, 3070.82227, 3071.0105, 3071.19873, 3071.38721, 3071.57544, 3071.76367, 3071.9519, 3072.14014, 3072.32837, 3072.5166, 3072.70508, 3072.89331, 3073.08154, 3073.26978, 3073.45801, 3073.64624, 3073.83472, 3074.02295, 3074.21118, 3074.39941, 3074.58765, 3074.77588, 3074.96411, 3075.15259, 3075.34082, 3075.52905, 3075.71729, 3075.90552, 3076.09375, 3076.28198, 3076.47046, 3076.65869, 3076.84692, 3077.03516, 3077.22339, 3077.41162, 3077.59985, 3077.78833, 3077.97656, 3078.16479, 3078.35303, 3078.54126, 3078.72949, 3078.91797, 3079.1062, 3079.29443, 3079.48267, 3079.6709, 3079.85913, 3080.04736, 3080.23584, 3080.42407, 3080.6123, 3080.80054, 3080.98877, 3081.177, 3081.36523, 3081.55371, 3081.74194, 3081.93018, 3082.11841, 3082.30664, 3082.49487, 3082.68335, 3082.87158, 3083.05981, 3083.24805, 3083.43628, 3083.62451, 3083.81274, 3084.00122, 3084.18945, 3084.37769};
    test_rebin_case( original_energies, original_counts, new_energies );
  }
  
  {
    printf( "Trying case with coutns at very end\n" );
    std::vector<float> original_energies{0.0163333565, 0.202889264, 0.389445186, 0.576000988, 0.762556911, 0.949112773, 1.13566864, 1.32222462, 1.50878036, 1.69533622, 1.88189209, 2.06844783, 2.25500369, 2.44155931, 2.62811542, 2.81467128, 3.0012269, 3.18778276, 3.37433839, 3.56089449, 3.74745011, 3.93400574, 4.1205616, 4.30711746, 4.49367332, 4.68022871, 4.86678457, 5.05334044, 5.2398963, 5.42645216, 5.61300755, 5.79956341, 5.98611879, 6.17267466, 6.35923004, 6.5457859, 6.73234129, 6.91889715, 7.10545301, 7.2920084, 7.47856426, 7.66511965, 7.85167551, 8.0382309, 8.22478676, 8.41134167, 8.59789753, 8.78445339, 8.9710083, 9.15756416, 9.34412003, 9.53067493, 9.7172308, 9.90378571, 10.0903425, 10.2768984, 10.4634533, 10.6500092, 10.8365641, 11.0231199, 11.2096748, 11.3962307, 11.5827856, 11.7693415, 11.9558964, 12.1424522, 12.3290071, 12.515563, 12.7021179, 12.8886738, 13.0752287, 13.2617846, 13.4483395, 13.6348953, 13.8214502, 14.008007, 14.194562, 14.3811169, 14.5676727, 14.7542276, 14.9407835, 15.1273384, 15.3138933, 15.5004492, 15.6870041, 15.87356, 16.0601139, 16.2466698, 16.4332237, 16.6197796, 16.8063354, 16.9928894, 17.1794453, 17.3660011, 17.5525551, 17.7391109, 17.9256668, 18.1122208, 18.2987766, 18.4853306, 3037.11963, 3037.30591, 3037.49243, 3037.67871, 3037.86523, 3038.05151, 3038.23828, 3038.42456, 3038.61108, 3038.79736, 3038.98389, 3039.17017, 3039.35669, 3039.54321, 3039.72974, 3039.91602, 3040.10254, 3040.28882, 3040.47534, 3040.66162, 3040.84814, 3041.03467, 3041.22119, 3041.40747, 3041.59399, 3041.78052, 3041.9668, 3042.15332, 3042.33984, 3042.52637, 3042.71265, 3042.89917, 3043.08545, 3043.27197, 3043.45825, 3043.64478, 3043.8313, 3044.01782, 3044.2041, 3044.39062, 3044.5769, 3044.76343, 3044.94971, 3045.13647, 3045.32275, 3045.50928, 3045.69556, 3045.88208, 3046.06836, 3046.25488, 3046.44116, 3046.62793, 3046.81421, 3047.00073, 3047.18701, 3047.37354, 3047.56006, 3047.74634, 3047.93311, 3048.11938, 3048.30591, 3048.49219, 3048.67871, 3048.86499, 3049.05151, 3049.23779, 3049.42456, 3049.61084, 3049.79736, 3049.98364, 3050.17017, 3050.35645, 3050.54297, 3050.72949, 3050.91602, 3051.10229, 3051.28882, 3051.4751, 3051.66162, 3051.8479, 3052.03442, 3052.22095, 3052.40747, 3052.59375, 3052.78027, 3052.96655, 3053.15308, 3053.33936, 3053.52612, 3053.71265, 3053.89893, 3054.08545, 3054.27173, 3054.45825, 3054.64453, 3054.83105, 3055.01758, 3055.2041, 3055.39038};
    std::vector<float> original_counts{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 27, 109, 269, 391, 386, 380, 345, 418, 413, 409, 358, 378, 392, 366, 402, 380, 391, 383, 350, 360, 388, 407, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 22, 19, 2, 8, 11, 1, 2, 5};
    std::vector<float> new_energies{-0.0297551602, 0.15851362, 0.346782386, 0.535051167, 0.723319948, 0.911588728, 1.09985757, 1.28812635, 1.47639513, 1.66466391, 1.85293269, 2.04120159, 2.22947025, 2.41773891, 2.60600781, 2.79427671, 2.98254538, 3.17081404, 3.35908294, 3.54735184, 3.7356205, 3.92388916, 4.1121583, 4.30042696, 4.48869562, 4.67696428, 4.86523294, 5.05350208, 5.24177074, 5.43003941, 5.61830854, 5.80657721, 5.99484587, 6.18311453, 6.37138319, 6.55965233, 6.74792099, 6.93618965, 7.12445879, 7.31272745, 7.50099611, 7.68926477, 7.87753344, 8.06580162, 8.25407124, 8.4423399, 8.63060856, 8.81887722, 9.00714588, 9.19541454, 9.3836832, 9.57195187, 9.76022053, 9.94849014, 10.1367588, 10.3250275, 10.5132961, 10.7015648, 10.8898335, 11.0781021, 11.2663717, 11.4546404, 11.642909, 11.8311777, 12.0194464, 12.207715, 12.3959837, 12.5842524, 12.772521, 12.9607906, 13.1490593, 13.337328, 13.5255966, 13.7138653, 13.9021339, 14.0904026, 14.2786722, 14.4669409, 14.6552095, 14.8434782, 15.0317469, 15.2200155, 15.4082842, 15.5965528, 15.7848215, 15.9730902, 16.1613598, 16.3496284, 16.537899, 16.7261677, 16.9144363, 17.102705, 17.2909737, 17.4792423, 17.667511, 17.8557796, 18.0440483, 18.232317, 18.4205856, 18.6088543, 3065.92725, 3066.11548, 3066.30396, 3066.49219, 3066.68042, 3066.86865, 3067.05688, 3067.24512, 3067.43335, 3067.62183, 3067.81006, 3067.99829, 3068.18652, 3068.37476, 3068.56299, 3068.75122, 3068.9397, 3069.12793, 3069.31616, 3069.50439, 3069.69263, 3069.88086, 3070.06934, 3070.25757, 3070.4458, 3070.63403, 3070.82227, 3071.0105, 3071.19873, 3071.38721, 3071.57544, 3071.76367, 3071.9519, 3072.14014, 3072.32837, 3072.5166, 3072.70508, 3072.89331, 3073.08154, 3073.26978, 3073.45801, 3073.64624, 3073.83472, 3074.02295, 3074.21118, 3074.39941, 3074.58765, 3074.77588, 3074.96411, 3075.15259, 3075.34082, 3075.52905, 3075.71729, 3075.90552, 3076.09375, 3076.28198, 3076.47046, 3076.65869, 3076.84692, 3077.03516, 3077.22339, 3077.41162, 3077.59985, 3077.78833, 3077.97656, 3078.16479, 3078.35303, 3078.54126, 3078.72949, 3078.91797, 3079.1062, 3079.29443, 3079.48267, 3079.6709, 3079.85913, 3080.04736, 3080.23584, 3080.42407, 3080.6123, 3080.80054, 3080.98877, 3081.177, 3081.36523, 3081.55371, 3081.74194, 3081.93018, 3082.11841, 3082.30664, 3082.49487, 3082.68335, 3082.87158, 3083.05981, 3083.24805, 3083.43628, 3083.62451, 3083.81274, 3084.00122, 3084.18945, 3084.37769};
    test_rebin_case( original_energies, original_counts, new_energies );
  }
  
  
  {
    printf( "Trying case with counts starting second bin\n" );
    std::vector<float> original_energies{0.190193534, 0.377671033, 0.565148532, 0.752626061, 0.940103471, 1.127581, 1.31505847, 1.50253594, 1.69001341, 1.87749088, 2.06496835, 2.25244594, 2.43992352, 2.62740064, 2.81487799, 3.00235558, 3.18983316, 3.37731075, 3.56478763, 3.75226521, 3.9397428, 4.12722015, 4.31469774, 4.50217533, 4.68965292, 4.87712955, 5.06460714, 5.25208473, 5.43956232, 5.62703943, 5.81451654, 6.00199413, 6.18947172, 6.37694883, 6.56442642, 6.75190353, 6.93938112, 7.12685823, 7.31433582, 7.50181341, 7.68929005, 7.87676764, 8.06424427, 8.25172138, 8.43919945, 8.62667656, 8.81415462, 9.00163078, 9.18910885, 9.37658596, 9.56406307, 9.75154114, 9.9390173, 10.1264954, 10.3139725, 10.5014496, 10.6889267, 10.8764038, 11.0638819, 11.251359, 11.4388351, 11.6263132, 11.8137903, 12.0012684, 12.1887445, 12.3762217, 12.5636997, 12.7511768, 12.9386539, 13.1261311, 13.3136082, 13.5010853, 13.6885624, 13.8760405, 14.0635166, 14.2509937, 14.4384718, 14.6259489, 14.813426, 15.0009031, 15.1883802, 15.3758574, 15.5633345, 15.7508116, 15.9382887, 16.1257668, 16.313242, 16.500721, 16.6881981, 16.8756752, 17.0631504, 17.2506275, 17.4381065, 17.6255836, 17.8130608, 18.000536, 18.188015, 18.3754921, 18.5629692, 18.7504463, 3052.72852, 3052.91602, 3053.10352, 3053.29077, 3053.47827, 3053.66577, 3053.85327, 3054.04028, 3054.22778, 3054.41528, 3054.60254, 3054.79004, 3054.97754, 3055.16504, 3055.35229, 3055.53979, 3055.72729, 3055.91479, 3056.10181, 3056.28931, 3056.47681, 3056.66406, 3056.85156, 3057.03906, 3057.22656, 3057.41382, 3057.60132, 3057.78882, 3057.97632, 3058.16333, 3058.35083, 3058.53833, 3058.72583, 3058.91309, 3059.10059, 3059.28809, 3059.47534, 3059.66284, 3059.85034, 3060.03784, 3060.22485, 3060.41235, 3060.59985, 3060.78735, 3060.97461, 3061.16211, 3061.34961, 3061.53711, 3061.72437, 3061.91187, 3062.09937, 3062.28638, 3062.47388, 3062.66138, 3062.84888, 3063.03613, 3063.22363, 3063.41113, 3063.59863, 3063.78589, 3063.97339, 3064.16089, 3064.3479, 3064.5354, 3064.7229, 3064.9104, 3065.09766, 3065.28516, 3065.47266, 3065.66016, 3065.84741, 3066.03491, 3066.22217, 3066.40967, 3066.59692, 3066.78442, 3066.97192, 3067.15918, 3067.34668, 3067.53418, 3067.72168, 3067.90894, 3068.09644, 3068.28369, 3068.47119, 3068.65845, 3068.84595, 3069.03345, 3069.2207, 3069.4082, 3069.5957, 3069.7832, 3069.97046, 3070.15796, 3070.34521, 3070.53271, 3070.71997, 3070.90747, 3071.09497};
    std::vector<float> original_counts{0, 15, 18, 19, 20, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 19, 37, 87, 120, 142, 153, 162, 152, 156, 153, 161, 142, 154, 170, 141, 125, 158, 143, 159, 128, 155, 153, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
    std::vector<float> new_energies{-0.0297551602, 0.15851362, 0.346782386, 0.535051167, 0.723319948, 0.911588728, 1.09985757, 1.28812635, 1.47639513, 1.66466391, 1.85293269, 2.04120159, 2.22947025, 2.41773891, 2.60600781, 2.79427671, 2.98254538, 3.17081404, 3.35908294, 3.54735184, 3.7356205, 3.92388916, 4.1121583, 4.30042696, 4.48869562, 4.67696428, 4.86523294, 5.05350208, 5.24177074, 5.43003941, 5.61830854, 5.80657721, 5.99484587, 6.18311453, 6.37138319, 6.55965233, 6.74792099, 6.93618965, 7.12445879, 7.31272745, 7.50099611, 7.68926477, 7.87753344, 8.06580162, 8.25407124, 8.4423399, 8.63060856, 8.81887722, 9.00714588, 9.19541454, 9.3836832, 9.57195187, 9.76022053, 9.94849014, 10.1367588, 10.3250275, 10.5132961, 10.7015648, 10.8898335, 11.0781021, 11.2663717, 11.4546404, 11.642909, 11.8311777, 12.0194464, 12.207715, 12.3959837, 12.5842524, 12.772521, 12.9607906, 13.1490593, 13.337328, 13.5255966, 13.7138653, 13.9021339, 14.0904026, 14.2786722, 14.4669409, 14.6552095, 14.8434782, 15.0317469, 15.2200155, 15.4082842, 15.5965528, 15.7848215, 15.9730902, 16.1613598, 16.3496284, 16.537899, 16.7261677, 16.9144363, 17.102705, 17.2909737, 17.4792423, 17.667511, 17.8557796, 18.0440483, 18.232317, 18.4205856, 18.6088543, 3065.92725, 3066.11548, 3066.30396, 3066.49219, 3066.68042, 3066.86865, 3067.05688, 3067.24512, 3067.43335, 3067.62183, 3067.81006, 3067.99829, 3068.18652, 3068.37476, 3068.56299, 3068.75122, 3068.9397, 3069.12793, 3069.31616, 3069.50439, 3069.69263, 3069.88086, 3070.06934, 3070.25757, 3070.4458, 3070.63403, 3070.82227, 3071.0105, 3071.19873, 3071.38721, 3071.57544, 3071.76367, 3071.9519, 3072.14014, 3072.32837, 3072.5166, 3072.70508, 3072.89331, 3073.08154, 3073.26978, 3073.45801, 3073.64624, 3073.83472, 3074.02295, 3074.21118, 3074.39941, 3074.58765, 3074.77588, 3074.96411, 3075.15259, 3075.34082, 3075.52905, 3075.71729, 3075.90552, 3076.09375, 3076.28198, 3076.47046, 3076.65869, 3076.84692, 3077.03516, 3077.22339, 3077.41162, 3077.59985, 3077.78833, 3077.97656, 3078.16479, 3078.35303, 3078.54126, 3078.72949, 3078.91797, 3079.1062, 3079.29443, 3079.48267, 3079.6709, 3079.85913, 3080.04736, 3080.23584, 3080.42407, 3080.6123, 3080.80054, 3080.98877, 3081.177, 3081.36523, 3081.55371, 3081.74194, 3081.93018, 3082.11841, 3082.30664, 3082.49487, 3082.68335, 3082.87158, 3083.05981, 3083.24805, 3083.43628, 3083.62451, 3083.81274, 3084.00122, 3084.18945, 3084.37769};
    test_rebin_case( original_energies, original_counts, new_energies );
  }
  
  {
    printf( "Trying case with counts starting third bin\n" );
    std::vector<float> original_energies{0.0410209, 0.2281221, 0.4152233, 0.602324486, 0.789425671, 0.976526797, 1.16362798, 1.35072911, 1.53783035, 1.72493148, 1.9120326, 2.09913373, 2.28623509, 2.47333598, 2.66043711, 2.84753847, 3.0346396, 3.22174048, 3.40884185, 3.59594297, 3.78304386, 3.97014523, 4.15724611, 4.344347, 4.53144836, 4.71854925, 4.90565062, 5.0927515, 5.27985239, 5.46695375, 5.65405512, 5.84115553, 6.02825689, 6.21535826, 6.40245867, 6.58956003, 6.7766614, 6.96376181, 7.15086317, 7.33796453, 7.52506495, 7.71216631, 7.8992672, 8.08636951, 8.27346897, 8.46057034, 8.6476717, 8.83477306, 9.02187347, 9.20897484, 9.39607525, 9.58317661, 9.77027702, 9.95737839, 10.1444798, 10.3315811, 10.5186806, 10.7057819, 10.8928833, 11.0799847, 11.2670851, 11.4541864, 11.6412868, 11.8283873, 12.0154886, 12.20259, 12.3896904, 12.5767908, 12.7638922, 12.9509926, 13.1380939, 13.3251953, 13.5122957, 13.6993961, 13.8864975, 14.0735979, 14.2606993, 14.4478006, 14.634901, 14.8220015, 15.0091019, 15.1962032, 15.3833046, 15.570405, 15.7575064, 15.9446058, 16.1317081, 16.3188095, 16.505909, 16.6930084, 16.8801098, 17.0672112, 17.2543125, 17.4414139, 17.6285133, 17.8156147, 18.0027161, 18.1898174, 18.3769169, 18.5640163, 3046.37109, 3046.55811, 3046.74512, 3046.93213, 3047.11914, 3047.3064, 3047.49316, 3047.68018, 3047.86743, 3048.05444, 3048.24121, 3048.42847, 3048.61548, 3048.80225, 3048.9895, 3049.17651, 3049.36353, 3049.55054, 3049.73755, 3049.92456, 3050.11157, 3050.29858, 3050.48584, 3050.67261, 3050.85986, 3051.04688, 3051.23364, 3051.4209, 3051.60791, 3051.79468, 3051.98193, 3052.16895, 3052.35571, 3052.54297, 3052.72998, 3052.91724, 3053.104, 3053.29102, 3053.47827, 3053.66504, 3053.85205, 3054.03931, 3054.22607, 3054.41309, 3054.60034, 3054.78711, 3054.97437, 3055.16138, 3055.34839, 3055.5354, 3055.72241, 3055.90942, 3056.09644, 3056.28345, 3056.4707, 3056.65747, 3056.84448, 3057.03174, 3057.21851, 3057.40552, 3057.59277, 3057.77954, 3057.96655, 3058.15381, 3058.34082, 3058.52783, 3058.71484, 3058.90186, 3059.08887, 3059.27588, 3059.46289, 3059.6499, 3059.83691, 3060.02393, 3060.21094, 3060.39795, 3060.58521, 3060.77222, 3060.95898, 3061.14624, 3061.33325, 3061.52002, 3061.70728, 3061.89429, 3062.0813, 3062.26831, 3062.45532, 3062.64233, 3062.82935, 3063.01636, 3063.20361, 3063.39038, 3063.57739, 3063.76465, 3063.95142, 3064.13867, 3064.32568, 3064.51245, 3064.69971};
    std::vector<float> original_counts{0, 0, 33, 34, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 9, 42, 163, 308, 396, 450, 428, 434, 428, 417, 422, 398, 438, 381, 382, 417, 416, 380, 399, 395, 373, 380, 383, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0};
    std::vector<float> new_energies{-0.0297551602, 0.15851362, 0.346782386, 0.535051167, 0.723319948, 0.911588728, 1.09985757, 1.28812635, 1.47639513, 1.66466391, 1.85293269, 2.04120159, 2.22947025, 2.41773891, 2.60600781, 2.79427671, 2.98254538, 3.17081404, 3.35908294, 3.54735184, 3.7356205, 3.92388916, 4.1121583, 4.30042696, 4.48869562, 4.67696428, 4.86523294, 5.05350208, 5.24177074, 5.43003941, 5.61830854, 5.80657721, 5.99484587, 6.18311453, 6.37138319, 6.55965233, 6.74792099, 6.93618965, 7.12445879, 7.31272745, 7.50099611, 7.68926477, 7.87753344, 8.06580162, 8.25407124, 8.4423399, 8.63060856, 8.81887722, 9.00714588, 9.19541454, 9.3836832, 9.57195187, 9.76022053, 9.94849014, 10.1367588, 10.3250275, 10.5132961, 10.7015648, 10.8898335, 11.0781021, 11.2663717, 11.4546404, 11.642909, 11.8311777, 12.0194464, 12.207715, 12.3959837, 12.5842524, 12.772521, 12.9607906, 13.1490593, 13.337328, 13.5255966, 13.7138653, 13.9021339, 14.0904026, 14.2786722, 14.4669409, 14.6552095, 14.8434782, 15.0317469, 15.2200155, 15.4082842, 15.5965528, 15.7848215, 15.9730902, 16.1613598, 16.3496284, 16.537899, 16.7261677, 16.9144363, 17.102705, 17.2909737, 17.4792423, 17.667511, 17.8557796, 18.0440483, 18.232317, 18.4205856, 18.6088543, 3065.92725, 3066.11548, 3066.30396, 3066.49219, 3066.68042, 3066.86865, 3067.05688, 3067.24512, 3067.43335, 3067.62183, 3067.81006, 3067.99829, 3068.18652, 3068.37476, 3068.56299, 3068.75122, 3068.9397, 3069.12793, 3069.31616, 3069.50439, 3069.69263, 3069.88086, 3070.06934, 3070.25757, 3070.4458, 3070.63403, 3070.82227, 3071.0105, 3071.19873, 3071.38721, 3071.57544, 3071.76367, 3071.9519, 3072.14014, 3072.32837, 3072.5166, 3072.70508, 3072.89331, 3073.08154, 3073.26978, 3073.45801, 3073.64624, 3073.83472, 3074.02295, 3074.21118, 3074.39941, 3074.58765, 3074.77588, 3074.96411, 3075.15259, 3075.34082, 3075.52905, 3075.71729, 3075.90552, 3076.09375, 3076.28198, 3076.47046, 3076.65869, 3076.84692, 3077.03516, 3077.22339, 3077.41162, 3077.59985, 3077.78833, 3077.97656, 3078.16479, 3078.35303, 3078.54126, 3078.72949, 3078.91797, 3079.1062, 3079.29443, 3079.48267, 3079.6709, 3079.85913, 3080.04736, 3080.23584, 3080.42407, 3080.6123, 3080.80054, 3080.98877, 3081.177, 3081.36523, 3081.55371, 3081.74194, 3081.93018, 3082.11841, 3082.30664, 3082.49487, 3082.68335, 3082.87158, 3083.05981, 3083.24805, 3083.43628, 3083.62451, 3083.81274, 3084.00122, 3084.18945, 3084.37769};
    std::vector<float> resulting_counts;
    test_rebin_case( original_energies, original_counts, new_energies );
  }
  
  {
    printf( "Trying case with counts in second to last bin\n" );
    std::vector<float> original_energies{0.221937045, 0.409898341, 0.597859621, 0.785820901, 0.973782182, 1.1617434, 1.34970474, 1.53766584, 1.72562718, 1.9135884, 2.10154939, 2.28951073, 2.47747183, 2.66543317, 2.85339403, 3.04135537, 3.22931647, 3.41727781, 3.60523891, 3.79319978, 3.98116112, 4.16912222, 4.3570838, 4.54504442, 4.733006, 4.92096663, 5.1089282, 5.29688883, 5.48484993, 5.67281103, 5.86077213, 6.04873323, 6.23669434, 6.42465496, 6.61261606, 6.80057716, 6.98853827, 7.17649889, 7.36445999, 7.55242109, 7.74038172, 7.92834282, 8.11630344, 8.30426407, 8.49222565, 8.68018723, 8.8681469, 9.05610847, 9.2440691, 9.43202972, 9.61999035, 9.80795193, 9.99591351, 10.1838732, 10.3718348, 10.5597954, 10.747756, 10.9357166, 11.1236773, 11.3116379, 11.4995985, 11.6875601, 11.8755207, 12.0634813, 12.251442, 12.4394026, 12.6273632, 12.8153238, 13.0032854, 13.191246, 13.3792057, 13.5671673, 13.7551279, 13.9430876, 14.1310492, 14.3190098, 14.5069695, 14.694931, 14.8828917, 15.0708523, 15.258812, 15.4467735, 15.6347342, 15.8226938, 16.0106544, 16.1986141, 16.3865757, 16.5745373, 16.7624969, 16.9504585, 17.1384182, 17.3263779, 17.5143375, 17.7022991, 17.8902607, 18.0782204, 18.2661819, 18.4541416, 18.6421013, 18.830061, 3060.00439, 3060.19214, 3060.37988, 3060.56787, 3060.75562, 3060.94336, 3061.1311, 3061.31885, 3061.50684, 3061.69458, 3061.88257, 3062.07031, 3062.25806, 3062.44604, 3062.63354, 3062.82153, 3063.00928, 3063.19727, 3063.38501, 3063.57275, 3063.76074, 3063.94849, 3064.13647, 3064.32397, 3064.51172, 3064.69971, 3064.88745, 3065.07544, 3065.26318, 3065.45093, 3065.63892, 3065.82666, 3066.0144, 3066.20215, 3066.39014, 3066.57788, 3066.76562, 3066.95361, 3067.14136, 3067.32935, 3067.51709, 3067.70459, 3067.89258, 3068.08032, 3068.26831, 3068.45605, 3068.6438, 3068.83179, 3069.01953, 3069.20752, 3069.39502, 3069.58301, 3069.77075, 3069.9585, 3070.14648, 3070.33423, 3070.52222, 3070.70996, 3070.89771, 3071.08545, 3071.27319, 3071.46118, 3071.64893, 3071.83667, 3072.02466, 3072.2124, 3072.40039, 3072.58813, 3072.77563, 3072.96362, 3073.15137, 3073.33936, 3073.5271, 3073.71509, 3073.90283, 3074.09058, 3074.27856, 3074.46606, 3074.65405, 3074.8418, 3075.02954, 3075.21753, 3075.40527, 3075.59326, 3075.78101, 3075.96875, 3076.15649, 3076.34424, 3076.53223, 3076.71997, 3076.90796, 3077.0957, 3077.28345, 3077.47144, 3077.65918, 3077.84692, 3078.03467, 3078.22241, 3078.4104};
    std::vector<float> original_counts{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 99, 0};
    std::vector<float> new_energies{-0.0297551602, 0.15851362, 0.346782386, 0.535051167, 0.723319948, 0.911588728, 1.09985757, 1.28812635, 1.47639513, 1.66466391, 1.85293269, 2.04120159, 2.22947025, 2.41773891, 2.60600781, 2.79427671, 2.98254538, 3.17081404, 3.35908294, 3.54735184, 3.7356205, 3.92388916, 4.1121583, 4.30042696, 4.48869562, 4.67696428, 4.86523294, 5.05350208, 5.24177074, 5.43003941, 5.61830854, 5.80657721, 5.99484587, 6.18311453, 6.37138319, 6.55965233, 6.74792099, 6.93618965, 7.12445879, 7.31272745, 7.50099611, 7.68926477, 7.87753344, 8.06580162, 8.25407124, 8.4423399, 8.63060856, 8.81887722, 9.00714588, 9.19541454, 9.3836832, 9.57195187, 9.76022053, 9.94849014, 10.1367588, 10.3250275, 10.5132961, 10.7015648, 10.8898335, 11.0781021, 11.2663717, 11.4546404, 11.642909, 11.8311777, 12.0194464, 12.207715, 12.3959837, 12.5842524, 12.772521, 12.9607906, 13.1490593, 13.337328, 13.5255966, 13.7138653, 13.9021339, 14.0904026, 14.2786722, 14.4669409, 14.6552095, 14.8434782, 15.0317469, 15.2200155, 15.4082842, 15.5965528, 15.7848215, 15.9730902, 16.1613598, 16.3496284, 16.537899, 16.7261677, 16.9144363, 17.102705, 17.2909737, 17.4792423, 17.667511, 17.8557796, 18.0440483, 18.232317, 18.4205856, 18.6088543, 3065.92725, 3066.11548, 3066.30396, 3066.49219, 3066.68042, 3066.86865, 3067.05688, 3067.24512, 3067.43335, 3067.62183, 3067.81006, 3067.99829, 3068.18652, 3068.37476, 3068.56299, 3068.75122, 3068.9397, 3069.12793, 3069.31616, 3069.50439, 3069.69263, 3069.88086, 3070.06934, 3070.25757, 3070.4458, 3070.63403, 3070.82227, 3071.0105, 3071.19873, 3071.38721, 3071.57544, 3071.76367, 3071.9519, 3072.14014, 3072.32837, 3072.5166, 3072.70508, 3072.89331, 3073.08154, 3073.26978, 3073.45801, 3073.64624, 3073.83472, 3074.02295, 3074.21118, 3074.39941, 3074.58765, 3074.77588, 3074.96411, 3075.15259, 3075.34082, 3075.52905, 3075.71729, 3075.90552, 3076.09375, 3076.28198, 3076.47046, 3076.65869, 3076.84692, 3077.03516, 3077.22339, 3077.41162, 3077.59985, 3077.78833, 3077.97656, 3078.16479, 3078.35303, 3078.54126, 3078.72949, 3078.91797, 3079.1062, 3079.29443, 3079.48267, 3079.6709, 3079.85913, 3080.04736, 3080.23584, 3080.42407, 3080.6123, 3080.80054, 3080.98877, 3081.177, 3081.36523, 3081.55371, 3081.74194, 3081.93018, 3082.11841, 3082.30664, 3082.49487, 3082.68335, 3082.87158, 3083.05981, 3083.24805, 3083.43628, 3083.62451, 3083.81274, 3084.00122, 3084.18945, 3084.37769};
    test_rebin_case( original_energies, original_counts, new_energies );
  }
  
  {
    printf( "Trying case with counts in last few bins\n" );
    std::vector<float> original_energies{0.0961009115, 0.282646596, 0.469192237, 0.655737936, 0.842283547, 1.0288291, 1.21537471, 1.40192032, 1.58846593, 1.77501142, 1.96155691, 2.14810228, 2.33464789, 2.52119327, 2.70773864, 2.89428425, 3.08082962, 3.26737499, 3.4539206, 3.64046574, 3.82701111, 4.01355648, 4.20010185, 4.38664722, 4.5731926, 4.75973749, 4.94628286, 5.13282824, 5.31937313, 5.5059185, 5.69246387, 5.87900877, 6.06555414, 6.25209951, 6.43864441, 6.62518978, 6.81173468, 6.99827957, 7.18482494, 7.37136984, 7.55791473, 7.74446011, 7.931005, 8.1175499, 8.30409431, 8.49063969, 8.6771841, 8.86372948, 9.05027485, 9.23681927, 9.42336369, 9.60990906, 9.79645348, 9.98299789, 10.1695433, 10.3560886, 10.5426331, 10.7291784, 10.9157228, 11.1022673, 11.2888126, 11.4753561, 11.6619005, 11.8484459, 12.0349903, 12.2215347, 12.4080801, 12.5946245, 12.7811689, 12.9677134, 13.1542578, 13.3408022, 13.5273476, 13.713891, 13.9004354, 14.0869808, 14.2735243, 14.4600687, 14.6466141, 14.8331575, 15.019702, 15.2062473, 15.3927908, 15.5793352, 15.7658796, 15.952424, 16.1389694, 16.3255138, 16.5120564, 16.6986008, 16.8851471, 17.0716896, 17.258234, 17.4447784, 17.631321, 17.8178673, 18.0044117, 18.1909542, 18.3774986, 18.564043, 3035.78027, 3035.96655, 3036.15283, 3036.33911, 3036.52539, 3036.71167, 3036.89819, 3037.08447, 3037.27075, 3037.45679, 3037.64307, 3037.82935, 3038.01562, 3038.2019, 3038.38818, 3038.57446, 3038.76074, 3038.94727, 3039.1333, 3039.31958, 3039.50586, 3039.69214, 3039.87842, 3040.0647, 3040.25098, 3040.43726, 3040.62329, 3040.80957, 3040.99609, 3041.18237, 3041.36865, 3041.55493, 3041.74121, 3041.92749, 3042.11377, 3042.2998, 3042.48608, 3042.67236, 3042.85864, 3043.04517, 3043.23145, 3043.41772, 3043.604, 3043.79028, 3043.97632, 3044.1626, 3044.34888, 3044.53516, 3044.72144, 3044.90771, 3045.09424, 3045.28052, 3045.46655, 3045.65283, 3045.83911, 3046.02539, 3046.21167, 3046.39795, 3046.58423, 3046.77051, 3046.95679, 3047.14307, 3047.32935, 3047.51562, 3047.7019, 3047.88818, 3048.07446, 3048.26074, 3048.44702, 3048.63306, 3048.81934, 3049.00562, 3049.19214, 3049.37842, 3049.5647, 3049.75098, 3049.93726, 3050.12354, 3050.30957, 3050.49585, 3050.68213, 3050.86841, 3051.05469, 3051.24121, 3051.42749, 3051.61377, 3051.7998, 3051.98608, 3052.17236, 3052.35864, 3052.54492, 3052.7312, 3052.91748, 3053.10376, 3053.29028, 3053.47632, 3053.6626, 3053.84888, 3054.03516};
    std::vector<float> original_counts{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 2, 17, 72, 126, 191, 225, 201, 224, 223, 225, 232, 208, 191, 213, 183, 199, 194, 200, 222, 208, 206, 206, 167, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 99, 0, 7, 99};
    std::vector<float> new_energies{-0.0297551602, 0.15851362, 0.346782386, 0.535051167, 0.723319948, 0.911588728, 1.09985757, 1.28812635, 1.47639513, 1.66466391, 1.85293269, 2.04120159, 2.22947025, 2.41773891, 2.60600781, 2.79427671, 2.98254538, 3.17081404, 3.35908294, 3.54735184, 3.7356205, 3.92388916, 4.1121583, 4.30042696, 4.48869562, 4.67696428, 4.86523294, 5.05350208, 5.24177074, 5.43003941, 5.61830854, 5.80657721, 5.99484587, 6.18311453, 6.37138319, 6.55965233, 6.74792099, 6.93618965, 7.12445879, 7.31272745, 7.50099611, 7.68926477, 7.87753344, 8.06580162, 8.25407124, 8.4423399, 8.63060856, 8.81887722, 9.00714588, 9.19541454, 9.3836832, 9.57195187, 9.76022053, 9.94849014, 10.1367588, 10.3250275, 10.5132961, 10.7015648, 10.8898335, 11.0781021, 11.2663717, 11.4546404, 11.642909, 11.8311777, 12.0194464, 12.207715, 12.3959837, 12.5842524, 12.772521, 12.9607906, 13.1490593, 13.337328, 13.5255966, 13.7138653, 13.9021339, 14.0904026, 14.2786722, 14.4669409, 14.6552095, 14.8434782, 15.0317469, 15.2200155, 15.4082842, 15.5965528, 15.7848215, 15.9730902, 16.1613598, 16.3496284, 16.537899, 16.7261677, 16.9144363, 17.102705, 17.2909737, 17.4792423, 17.667511, 17.8557796, 18.0440483, 18.232317, 18.4205856, 18.6088543, 3065.92725, 3066.11548, 3066.30396, 3066.49219, 3066.68042, 3066.86865, 3067.05688, 3067.24512, 3067.43335, 3067.62183, 3067.81006, 3067.99829, 3068.18652, 3068.37476, 3068.56299, 3068.75122, 3068.9397, 3069.12793, 3069.31616, 3069.50439, 3069.69263, 3069.88086, 3070.06934, 3070.25757, 3070.4458, 3070.63403, 3070.82227, 3071.0105, 3071.19873, 3071.38721, 3071.57544, 3071.76367, 3071.9519, 3072.14014, 3072.32837, 3072.5166, 3072.70508, 3072.89331, 3073.08154, 3073.26978, 3073.45801, 3073.64624, 3073.83472, 3074.02295, 3074.21118, 3074.39941, 3074.58765, 3074.77588, 3074.96411, 3075.15259, 3075.34082, 3075.52905, 3075.71729, 3075.90552, 3076.09375, 3076.28198, 3076.47046, 3076.65869, 3076.84692, 3077.03516, 3077.22339, 3077.41162, 3077.59985, 3077.78833, 3077.97656, 3078.16479, 3078.35303, 3078.54126, 3078.72949, 3078.91797, 3079.1062, 3079.29443, 3079.48267, 3079.6709, 3079.85913, 3080.04736, 3080.23584, 3080.42407, 3080.6123, 3080.80054, 3080.98877, 3081.177, 3081.36523, 3081.55371, 3081.74194, 3081.93018, 3082.11841, 3082.30664, 3082.49487, 3082.68335, 3082.87158, 3083.05981, 3083.24805, 3083.43628, 3083.62451, 3083.81274, 3084.00122, 3084.18945, 3084.37769};
    std::vector<float> resulting_counts;
    test_rebin_case( original_energies, original_counts, new_energies );
  }
  
  {
    std::vector<float> original_energies{-0.123889551, 0.0645787269, 0.253046989, 0.441515207, 0.629983425, 0.818451583, 1.00691974, 1.19538784, 1.38385594, 1.57232416, 1.76079214, 1.94926012, 2.13772845, 2.32619619, 2.51466417, 2.70313239, 2.89160013, 3.08006787, 3.26853585, 3.45700383, 3.64547157, 3.83393931, 4.02240705, 4.21087456, 4.39934254, 4.58781004, 4.77627802, 4.96474552, 5.15321302, 5.341681, 5.53014851, 5.71861553, 5.90708351, 6.09555101, 6.28401804, 6.47248602, 6.66095352, 6.84942055, 7.03788805, 7.22635555, 7.41482258, 7.60329008, 7.79175758, 7.98022461, 8.16869068, 8.35715866, 8.54562569, 8.73409271, 8.92256069, 9.11102676, 9.29949379, 9.48796177, 9.67642784, 9.86489487, 10.0533628, 10.2418289, 10.4302959, 10.6187639, 10.80723, 10.995697, 11.184164, 11.3726301, 11.5610971, 11.7495642, 11.9380312, 12.1264973, 12.3149643, 12.5034313, 12.6918974, 12.8803644, 13.0688305, 13.2572975, 13.4457645, 13.6342306, 13.8226967, 14.0111637, 14.1996298, 14.3880959, 14.5765629, 14.765029, 14.953495, 15.1419621, 15.3304281, 15.5188942, 15.7073612, 15.8958263, 16.0842934, 16.2727604, 16.4612255, 16.6496906, 16.8381577, 17.0266228, 17.2150898, 17.4035568, 17.5920219, 17.7804871, 17.9689541, 18.1574192, 18.3458862, 18.5343513, 3065.85278, 3066.04077, 3066.229, 3066.41699, 3066.60522, 3066.79321, 3066.9812, 3067.16943, 3067.35742, 3067.54541, 3067.73364, 3067.92163, 3068.10986, 3068.29785, 3068.48584, 3068.67407, 3068.86206, 3069.05005, 3069.23828, 3069.42627, 3069.6145, 3069.80249, 3069.99048, 3070.17871, 3070.3667, 3070.55469, 3070.74268, 3070.93066, 3071.11865, 3071.30688, 3071.49487, 3071.68311, 3071.87109, 3072.05908, 3072.24731, 3072.4353, 3072.62329, 3072.81152, 3072.99951, 3073.18774, 3073.37573, 3073.56372, 3073.75195, 3073.93994, 3074.12793, 3074.31616, 3074.50415, 3074.69238, 3074.88037, 3075.06836, 3075.25659, 3075.44458, 3075.63257, 3075.8208, 3076.00879, 3076.19678, 3076.38477, 3076.57275, 3076.76099, 3076.94897, 3077.13696, 3077.3252, 3077.51318, 3077.70117, 3077.8894, 3078.07739, 3078.26562, 3078.45361, 3078.6416, 3078.82983, 3079.01782, 3079.20581, 3079.39404, 3079.58203, 3079.77026, 3079.95825, 3080.14624, 3080.33447, 3080.52246, 3080.71045, 3080.89868, 3081.08667, 3081.27466, 3081.46289, 3081.65088, 3081.83887, 3082.02686, 3082.21484, 3082.40308, 3082.59106, 3082.77905, 3082.96729, 3083.15527, 3083.34351, 3083.53149, 3083.71948, 3083.90771, 3084.0957, 3084.28369};
    std::vector<float> original_counts{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 2, 14, 83, 195, 317, 341, 340, 358, 336, 366, 386, 330, 346, 332, 347, 351, 317, 351, 290, 332, 344, 288, 289, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 3, 0};
    std::vector<float> new_energies{-0.0297551602, 0.15851362, 0.346782386, 0.535051167, 0.723319948, 0.911588728, 1.09985757, 1.28812635, 1.47639513, 1.66466391, 1.85293269, 2.04120159, 2.22947025, 2.41773891, 2.60600781, 2.79427671, 2.98254538, 3.17081404, 3.35908294, 3.54735184, 3.7356205, 3.92388916, 4.1121583, 4.30042696, 4.48869562, 4.67696428, 4.86523294, 5.05350208, 5.24177074, 5.43003941, 5.61830854, 5.80657721, 5.99484587, 6.18311453, 6.37138319, 6.55965233, 6.74792099, 6.93618965, 7.12445879, 7.31272745, 7.50099611, 7.68926477, 7.87753344, 8.06580162, 8.25407124, 8.4423399, 8.63060856, 8.81887722, 9.00714588, 9.19541454, 9.3836832, 9.57195187, 9.76022053, 9.94849014, 10.1367588, 10.3250275, 10.5132961, 10.7015648, 10.8898335, 11.0781021, 11.2663717, 11.4546404, 11.642909, 11.8311777, 12.0194464, 12.207715, 12.3959837, 12.5842524, 12.772521, 12.9607906, 13.1490593, 13.337328, 13.5255966, 13.7138653, 13.9021339, 14.0904026, 14.2786722, 14.4669409, 14.6552095, 14.8434782, 15.0317469, 15.2200155, 15.4082842, 15.5965528, 15.7848215, 15.9730902, 16.1613598, 16.3496284, 16.537899, 16.7261677, 16.9144363, 17.102705, 17.2909737, 17.4792423, 17.667511, 17.8557796, 18.0440483, 18.232317, 18.4205856, 18.6088543, 3065.92725, 3066.11548, 3066.30396, 3066.49219, 3066.68042, 3066.86865, 3067.05688, 3067.24512, 3067.43335, 3067.62183, 3067.81006, 3067.99829, 3068.18652, 3068.37476, 3068.56299, 3068.75122, 3068.9397, 3069.12793, 3069.31616, 3069.50439, 3069.69263, 3069.88086, 3070.06934, 3070.25757, 3070.4458, 3070.63403, 3070.82227, 3071.0105, 3071.19873, 3071.38721, 3071.57544, 3071.76367, 3071.9519, 3072.14014, 3072.32837, 3072.5166, 3072.70508, 3072.89331, 3073.08154, 3073.26978, 3073.45801, 3073.64624, 3073.83472, 3074.02295, 3074.21118, 3074.39941, 3074.58765, 3074.77588, 3074.96411, 3075.15259, 3075.34082, 3075.52905, 3075.71729, 3075.90552, 3076.09375, 3076.28198, 3076.47046, 3076.65869, 3076.84692, 3077.03516, 3077.22339, 3077.41162, 3077.59985, 3077.78833, 3077.97656, 3078.16479, 3078.35303, 3078.54126, 3078.72949, 3078.91797, 3079.1062, 3079.29443, 3079.48267, 3079.6709, 3079.85913, 3080.04736, 3080.23584, 3080.42407, 3080.6123, 3080.80054, 3080.98877, 3081.177, 3081.36523, 3081.55371, 3081.74194, 3081.93018, 3082.11841, 3082.30664, 3082.49487, 3082.68335, 3082.87158, 3083.05981, 3083.24805, 3083.43628, 3083.62451, 3083.81274, 3084.00122, 3084.18945, 3084.37769};
    std::vector<float> resulting_counts;
    test_rebin_case( original_energies, original_counts, new_energies );
  }
  
  {
    std::vector<float> original_energies{-0.0226090029, 0.164937198, 0.352483392, 0.540029585, 0.727575779, 0.915121973, 1.10266817, 1.2902143, 1.47776055, 1.66530681, 1.85285294, 2.04039907, 2.22794533, 2.41549158, 2.6030376, 2.79058385, 2.9781301, 3.16567612, 3.35322237, 3.54076838, 3.72831464, 3.91586089, 4.10340691, 4.29095316, 4.47849894, 4.66604519, 4.85359144, 5.0411377, 5.22868347, 5.41622972, 5.60377598, 5.79132223, 5.97886848, 6.16641474, 6.35396099, 6.54150724, 6.7290535, 6.91659927, 7.10414553, 7.29169178, 7.47923803, 7.66678429, 7.85433006, 8.04187679, 8.22942257, 8.4169693, 8.60451508, 8.79206181, 8.97960758, 9.16715336, 9.35470009, 9.54224586, 9.72979259, 9.91733837, 10.1048851, 10.2924309, 10.4799767, 10.6675234, 10.8550692, 11.0426149, 11.2301607, 11.4177074, 11.6052532, 11.7927999, 11.9803457, 12.1678915, 12.3554382, 12.542984, 12.7305307, 12.9180765, 13.1056232, 13.293169, 13.4807158, 13.6682615, 13.8558073, 14.043354, 14.2308989, 14.4184456, 14.6059914, 14.7935381, 14.9810839, 15.1686296, 15.3561764, 15.5437222, 15.7312689, 15.9188147, 16.1063595, 16.2939053, 16.481451, 16.6689968, 16.8565445, 17.0440903, 17.231636, 17.4191818, 17.6067295, 17.7942753, 17.9818211, 18.1693668, 18.3569126, 18.5444603, 3054.05688, 3054.24438, 3054.43213, 3054.61963, 3054.80713, 3054.99438, 3055.18188, 3055.36963, 3055.55713, 3055.74463, 3055.93213, 3056.11963, 3056.30737, 3056.49487, 3056.68237, 3056.86987, 3057.05737, 3057.24487, 3057.43262, 3057.62012, 3057.80762, 3057.99512, 3058.18262, 3058.37012, 3058.55762, 3058.74512, 3058.93262, 3059.12012, 3059.30786, 3059.49536, 3059.68286, 3059.87036, 3060.05786, 3060.24561, 3060.43311, 3060.62061, 3060.80811, 3060.99561, 3061.18311, 3061.37085, 3061.55835, 3061.74561, 3061.93311, 3062.12061, 3062.30835, 3062.49585, 3062.68335, 3062.87085, 3063.05835, 3063.24609, 3063.43359, 3063.62109, 3063.80859, 3063.99609, 3064.18359, 3064.37134, 3064.55884, 3064.74634, 3064.93384, 3065.12109, 3065.30884, 3065.49634, 3065.68384, 3065.87134, 3066.05884, 3066.24658, 3066.43408, 3066.62158, 3066.80908, 3066.99658, 3067.18433, 3067.37183, 3067.55933, 3067.74683, 3067.93433, 3068.12183, 3068.30957, 3068.49683, 3068.68433, 3068.87183, 3069.05933, 3069.24707, 3069.43457, 3069.62207, 3069.80957, 3069.99707, 3070.18481, 3070.37231, 3070.55981, 3070.74731, 3070.93481, 3071.12231, 3071.31006, 3071.49756, 3071.68506, 3071.87231, 3072.05981, 3072.24756, 3072.43506};
    std::vector<float> original_counts{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 3, 14, 53, 119, 229, 358, 375, 396, 360, 401, 410, 420, 458, 438, 437, 417, 403, 414, 416, 404, 386, 423, 405, 369, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0};
    std::vector<float> new_energies{-0.0297551602, 0.15851362, 0.346782386, 0.535051167, 0.723319948, 0.911588728, 1.09985757, 1.28812635, 1.47639513, 1.66466391, 1.85293269, 2.04120159, 2.22947025, 2.41773891, 2.60600781, 2.79427671, 2.98254538, 3.17081404, 3.35908294, 3.54735184, 3.7356205, 3.92388916, 4.1121583, 4.30042696, 4.48869562, 4.67696428, 4.86523294, 5.05350208, 5.24177074, 5.43003941, 5.61830854, 5.80657721, 5.99484587, 6.18311453, 6.37138319, 6.55965233, 6.74792099, 6.93618965, 7.12445879, 7.31272745, 7.50099611, 7.68926477, 7.87753344, 8.06580162, 8.25407124, 8.4423399, 8.63060856, 8.81887722, 9.00714588, 9.19541454, 9.3836832, 9.57195187, 9.76022053, 9.94849014, 10.1367588, 10.3250275, 10.5132961, 10.7015648, 10.8898335, 11.0781021, 11.2663717, 11.4546404, 11.642909, 11.8311777, 12.0194464, 12.207715, 12.3959837, 12.5842524, 12.772521, 12.9607906, 13.1490593, 13.337328, 13.5255966, 13.7138653, 13.9021339, 14.0904026, 14.2786722, 14.4669409, 14.6552095, 14.8434782, 15.0317469, 15.2200155, 15.4082842, 15.5965528, 15.7848215, 15.9730902, 16.1613598, 16.3496284, 16.537899, 16.7261677, 16.9144363, 17.102705, 17.2909737, 17.4792423, 17.667511, 17.8557796, 18.0440483, 18.232317, 18.4205856, 18.6088543, 3065.92725, 3066.11548, 3066.30396, 3066.49219, 3066.68042, 3066.86865, 3067.05688, 3067.24512, 3067.43335, 3067.62183, 3067.81006, 3067.99829, 3068.18652, 3068.37476, 3068.56299, 3068.75122, 3068.9397, 3069.12793, 3069.31616, 3069.50439, 3069.69263, 3069.88086, 3070.06934, 3070.25757, 3070.4458, 3070.63403, 3070.82227, 3071.0105, 3071.19873, 3071.38721, 3071.57544, 3071.76367, 3071.9519, 3072.14014, 3072.32837, 3072.5166, 3072.70508, 3072.89331, 3073.08154, 3073.26978, 3073.45801, 3073.64624, 3073.83472, 3074.02295, 3074.21118, 3074.39941, 3074.58765, 3074.77588, 3074.96411, 3075.15259, 3075.34082, 3075.52905, 3075.71729, 3075.90552, 3076.09375, 3076.28198, 3076.47046, 3076.65869, 3076.84692, 3077.03516, 3077.22339, 3077.41162, 3077.59985, 3077.78833, 3077.97656, 3078.16479, 3078.35303, 3078.54126, 3078.72949, 3078.91797, 3079.1062, 3079.29443, 3079.48267, 3079.6709, 3079.85913, 3080.04736, 3080.23584, 3080.42407, 3080.6123, 3080.80054, 3080.98877, 3081.177, 3081.36523, 3081.55371, 3081.74194, 3081.93018, 3082.11841, 3082.30664, 3082.49487, 3082.68335, 3082.87158, 3083.05981, 3083.24805, 3083.43628, 3083.62451, 3083.81274, 3084.00122, 3084.18945, 3084.37769};
    std::vector<float> resulting_counts;
    test_rebin_case( original_energies, original_counts, new_energies );
  }
}

int main( int argc, char **argv )
{
  test_rebin();
  return 1;
}


